<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mcmp.azure.vm.rightsizer.mapper.VmCostAnalysisMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="vmMonthlyAvgCostResultMap" type="com.mcmp.azure.vm.rightsizer.dto.VmMonthlyAvgCostDto">
        <result property="subscriptionId" column="subscription_id"/>
        <result property="vmId" column="vm_id"/>
        <result property="avgCost" column="avg_cost"/>
        <result property="dayCount" column="day_count"/>
        <result property="latestCost" column="latest_cost"/>
        <result property="totalCost" column="total_cost"/>
        <result property="fromDate" column="from_date"/>
        <result property="toDate" column="to_date"/>
        <result property="dataRange" column="data_range"/>
        <result property="projectCd" column="project_cd"/>
        <result property="workspaceCd" column="workspace_cd"/>
    </resultMap>

    <!-- 특정 VM의 월별 평균 비용 조회 (servicegroup_meta 조인 추가) -->
    <select id="selectMonthlyAvgCostByVmId" resultMap="vmMonthlyAvgCostResultMap">
        SELECT base.subscription_id,
               base.vm_id,
               base.avg_cost,
               base.day_count,
               COALESCE(latest.latest_cost, 0) as latest_cost,
               base.total_cost,
               base.from_date,
               base.to_date,
               base.data_range,
               COALESCE(meta.service_cd, 'default') as project_cd,
               COALESCE(meta.workspace_cd, 'undefined') as workspace_cd
        FROM (SELECT subscription_id,
                     vm_id,
                     AVG(pre_tax_cost)                                                                as avg_cost,
                     COUNT(*)                                                                         as day_count,
                     SUM(pre_tax_cost)                                                                as total_cost,
                     MIN(usage_date)                                                                  as from_date,
                     MAX(usage_date)                                                                  as to_date,
                     IF(MIN(usage_date) <![CDATA[ < ]]> DATE_FORMAT(CURDATE(), '%Y%m01'), 'LAST_MONTH', 'ALL_DATA') as data_range
              FROM azure_cost_vm_daily
              WHERE vm_id = #{vmId}
                AND (
                  -- 지난달 데이터가 있으면 지난달만
                  (usage_date >= DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 MONTH), '%Y%m01')
                      AND usage_date <![CDATA[ < ]]> DATE_FORMAT(CURDATE(), '%Y%m01')
                      AND vm_id IN (SELECT DISTINCT vm_id
                                    FROM azure_cost_vm_daily
                                    WHERE vm_id = #{vmId}
                                      AND usage_date >= DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 MONTH), '%Y%m01')
                                      AND usage_date <![CDATA[ < ]]> DATE_FORMAT(CURDATE(), '%Y%m01')))
                      -- 지난달 데이터가 없으면 전체
                      OR vm_id NOT IN (SELECT DISTINCT vm_id
                                       FROM azure_cost_vm_daily
                                       WHERE vm_id = #{vmId}
                                         AND usage_date >= DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 MONTH), '%Y%m01')
                                         AND usage_date <![CDATA[ < ]]> DATE_FORMAT(CURDATE(), '%Y%m01'))
                  )
              GROUP BY subscription_id, vm_id) base
                 LEFT JOIN (
                     -- 오늘(금일) 비용 = 전체 데이터 중 가장 최신 날짜의 비용
                     SELECT t.vm_id,
                            t.usage_date,
                            t.pre_tax_cost as latest_cost
                     FROM azure_cost_vm_daily t
                     INNER JOIN (
                         SELECT vm_id, MAX(usage_date) as max_date
                         FROM azure_cost_vm_daily
                         WHERE vm_id = #{vmId}
                         GROUP BY vm_id
                     ) m ON t.vm_id = m.vm_id AND t.usage_date = m.max_date
                     LIMIT 1
                 ) latest ON base.vm_id = latest.vm_id
                 LEFT JOIN servicegroup_meta meta
                           ON meta.csp_type = 'AZURE'
                           AND meta.csp_account COLLATE utf8mb4_unicode_520_ci = base.subscription_id
    </select>

    <!-- 전체 VM의 월별 평균 비용 조회 (servicegroup_meta 조인 추가) -->
    <select id="selectMonthlyAvgCostAllVm" resultMap="vmMonthlyAvgCostResultMap">
        SELECT base.subscription_id,
               base.vm_id,
               base.avg_cost,
               base.day_count,
               COALESCE(latest.latest_cost, 0) as latest_cost,
               base.total_cost,
               base.from_date,
               base.to_date,
               base.data_range,
               COALESCE(meta.service_cd, 'default') as project_cd,
               COALESCE(meta.workspace_cd, 'undefined') as workspace_cd
        FROM (SELECT subscription_id,
                     vm_id,
                     AVG(pre_tax_cost)                                                                as avg_cost,
                     COUNT(*)                                                                         as day_count,
                     SUM(pre_tax_cost)                                                                as total_cost,
                     MIN(usage_date)                                                                  as from_date,
                     MAX(usage_date)                                                                  as to_date,
                     IF(MIN(usage_date) <![CDATA[ < ]]> DATE_FORMAT(CURDATE(), '%Y%m01'), 'LAST_MONTH', 'ALL_DATA') as data_range
              FROM azure_cost_vm_daily
              WHERE (
                        -- 지난달 데이터가 있으면 지난달만
                        (usage_date >= DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 MONTH), '%Y%m01')
                            AND usage_date <![CDATA[ < ]]> DATE_FORMAT(CURDATE(), '%Y%m01')
                            AND vm_id IN (SELECT DISTINCT vm_id
                                          FROM azure_cost_vm_daily
                                          WHERE
                                              usage_date >= DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 MONTH), '%Y%m01')
                                            AND usage_date <![CDATA[ < ]]> DATE_FORMAT(CURDATE(), '%Y%m01')))
                            -- 지난달 데이터가 없으면 전체
                            OR vm_id NOT IN (SELECT DISTINCT vm_id
                                             FROM azure_cost_vm_daily
                                             WHERE usage_date >=
                                                   DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 MONTH), '%Y%m01')
                                               AND usage_date <![CDATA[ < ]]> DATE_FORMAT(CURDATE(), '%Y%m01'))
                        )
              GROUP BY subscription_id, vm_id) base
                 LEFT JOIN (
                     -- 오늘(금일) 비용 = 전체 데이터 중 가장 최신 날짜의 비용
                     SELECT t.vm_id,
                            t.usage_date,
                            SUM(t.pre_tax_cost) as latest_cost
                     FROM azure_cost_vm_daily t
                     INNER JOIN (
                         SELECT vm_id, MAX(usage_date) as max_date
                         FROM azure_cost_vm_daily
                         GROUP BY vm_id
                     ) m ON t.vm_id = m.vm_id AND t.usage_date = m.max_date
                     GROUP BY t.vm_id, t.usage_date
                 ) latest ON base.vm_id = latest.vm_id
                 LEFT JOIN servicegroup_meta meta
                           ON meta.csp_type = 'AZURE'
                           AND meta.csp_account COLLATE utf8mb4_unicode_520_ci = base.subscription_id
    </select>

</mapper>